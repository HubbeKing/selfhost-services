kind: pipeline
type: kubernetes
name: default

steps:
  - name: kubectl-proxy
    image: registry.hubbe.club/autoapply:v1.21.3
    pull: if-not-exists
    detach: true
    commands:
      - kubectl proxy

  - name: apply
    image: registry.hubbe.club/autoapply:v1.21.3
    pull: if-not-exists
    environment:
      AGE_KEY:
        from_secret: age_key
      SOPS_AGE_KEY_FILE: /keys.txt
    commands:
      # create keys.txt file
      - echo ${AGE_KEY} > /keys.txt
      # run SOPS decryption on secrets
      - find '.' -type f -name '*.yaml' -exec sops --decrypt --in-place '{}' \;
      # apply manifests with kubectl
      - kubectl apply -R -f core/
      - kubectl apply -R -f monitoring/manifests
      - kubectl apply -R -f volumes/
      - kubectl apply -f nginx/
      - kubectl apply -R -f apps/
    resources:
      requests:
        cpu: 500
        memory: 128MiB
      limits:
        cpu: 500
        memory: 256MiB

image_pull_secrets:
  - registry_pull_secret
