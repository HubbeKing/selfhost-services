apiVersion: v1
kind: ConfigMap
metadata:
  name: mariadb-scripts
  namespace: authelia
data:
  # if we are pod ordinal 0, and we cannot reach any other pods, do a cluster-up for the mariadb galera cluster.
  # otherwise, attempt to join the existing galera cluster.
  # this is only really a problem if pod 0 ever crashes, which can happen.
  startup.sh: |
    #!/bin/sh
    # manually set wsrep_node_address and wsrep_node_name in galera config based on pod IP and hostname
    sed -i 's|POD_IP|'"$POD_IP"'|' /etc/mysql/conf.d/galera.cnf
    sed -i 's|HOSTNAME|'"$HOSTNAME"'|' /etc/mysql/conf.d/galera.cnf
    ORDINAL=${HOSTNAME##*-}
    if [ $ORDINAL = "0" ]; then
      # pod-0
      # check if cluster is already up
      if mysql --host=mariadb.authelia.svc.cluster.local --user=${MYSQL_USER} --password=${MYSQL_PASSWORD} --execute 'SELECT 1'; then
        # connect to cluster
        docker-entrypoint.sh mysqld
      else
        # new cluster
        echo "INFO: Assuming cluster is not up. Bootstrapping..."
        grep -q 'safe_to_bootstrap: 0' /var/lib/mysql/grastate.dat
        BOOTSTRAP_SAFE=$?
        if [ $BOOTSTRAP_SAFE = 0 ] && [ $BOOTSTRAP_FORCE = true ]; then
            echo "WARNING: safe_to_bootstrap is 0 but $BOOTSTRAP_FORCE is true, forcing bootstrap..."
            sed -i 's|safe_to_bootstrap: 0|safe_to_bootstrap: 1|' /var/lib/mysql/grastate.dat
        fi
        docker-entrypoint.sh mysqld --wsrep-new-cluster
      fi
    else
      # pod-1 or above, connect to cluster
      docker-entrypoint.sh mysqld
    fi
  shutdown.sh: |
    #!/bin/sh
    ORDINAL=${HOSTNAME##*-}
    # if we're ordinal 0, nap for 15s, in case this is a delete
    # so that higher ordinals have time for graceful shutdown
    if [ $ORDINAL = "0" ]; then
      sleep 15
    fi
    # gracefully shutdown - this doesn't happen on SIGTERM if there's open connections, but we WANT it to.
    mysql --host=localhost --user=root --password=${MYSQL_ROOT_PASSWORD} --execute 'SHUTDOWN WAIT FOR ALL REPLICAS'
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mariadb-configs
  namespace: authelia
data:
  galera.cnf: |
    [galera]
    wsrep_on=ON
    wsrep_provider="/usr/lib/libgalera_smm.so"
    wsrep_cluster_address="gcomm://mariadb-0.mariadb-headless.authelia.svc.cluster.local,mariadb-1.mariadb-headless.authelia.svc.cluster.local,mariadb-2.mariadb-headless.authelia.svc.cluster.local"
    wsrep_cluster_name="authelia"
    wsrep_node_address=POD_IP
    wsrep_node_name=HOSTNAME
    binlog_format=ROW
    default_storage_engine=InnoDB
    innodb_autoinc_lock_mode=2
    innodb_doublewrite=1
    query_cache_size=0
    innodb_flush_log_at_trx_commit=0
