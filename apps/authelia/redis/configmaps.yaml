apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-scripts
  namespace: authelia
data:
  # start redis or sentinel as primary or replica depending on ordinal
  # pod 0 is primary by default, further pods are replicas by default
  # sentinels handle primary election if pod 0 ever fails or restarts and cleanly promotes another replica to primary, and demotes pod 0 when it comes back up
  # of note: new replica nodes require pod 0 to be healthy in order to do initial sync. scaling likely fails if pod 0 is down.
  startup.sh: |
    #!/bin/sh
    ORDINAL=${HOSTNAME##*-}
    if [ "$1" = "redis" ] && [ $ORDINAL = "0" ]
    then
      # redis primary
      redis-server /configs/redis.conf --cluster-announce-ip $POD_IP --cluster-announce-port 26379
    elif [ "$1" = "redis" ] && [ $ORDINAL != "0" ]
    then
      # redis replica
      redis-server /configs/redis.conf --replica-announce-ip $POD_IP --replicaof redis-0.redis.authelia.svc.cluster.local 6379
    elif [ "$1" = "sentinel" ] && [ $ORDINAL = "0" ]
    then
      # sentinel primary
      redis-server /configs/sentinel.conf --sentinel announce-ip $POD_IP --sentinel monitor authelia $POD_IP 6379 2
    elif [ "$1" = "sentinel" ] && [ $ORDINAL != "0" ]
    then
      # sentinel replica
      redis-server /configs/sentinel.conf --sentinel announce-ip $POD_IP --sentinel monitor authelia redis-0.redis.authelia.svc.cluster.local 6379 2
    else
      exit 1
    fi
  # sentinel monitor syntax: --sentinel monitor PRIMARY_NAME PRIMARY_HOST_NAME_OR_IP REDIS_PORT QUORUM
  # QUORUM is the number of sentinels that need to agree that the primary is down in order to promote a secondary
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: redis-configs
  namespace: authelia
data:
  # minimal configs, copied into writeable emptyDir volume by initContainer
  # (redis-sentinel does not start without a writeable config file)
  redis.conf: |
    bind 0.0.0.0
    port 6379
    protected-mode no
    requirepass Deplete-Finished-Rosy2
  sentinel.conf: |
    bind 0.0.0.0
    port 26379
    protected-mode no
    sentinel announce-port 26379
    sentinel down-after-milliseconds authelia 5000
    sentinel parallel-syncs authelia 1
    sentinel failover-timeout authelia 180000
    sentinel resolve-hostnames yes
