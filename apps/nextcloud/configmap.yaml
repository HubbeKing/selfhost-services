apiVersion: v1
kind: ConfigMap
metadata:
  name: nextcloud-scripts
data:
  preview-pre-generate.sh: |
    #!/bin/sh
    # Point to the internal API server hostname
    APISERVER=https://kubernetes.default.svc

    # Path to ServiceAccount token
    SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount

    # Read the ServiceAccount bearer token
    TOKEN=$(cat ${SERVICEACCOUNT}/token)

    # Reference the internal certificate authority (CA)
    CACERT=${SERVICEACCOUNT}/ca.crt

    # exec to default/nextcloud-web-0 pod and run:
    # sudo -u abc php /config/www/nextcloud/occ preview:pre-generate
    curl \
    --cacert ${CACERT} \
    --header "Authorization: Bearer ${TOKEN}" \
    -X POST \
    ${APISERVER}/api/v1/namespaces/default/pods/nextcloud-web-0/exec?command=sudo&command=-u&command=abc&command=php&command=%2Fconfig%2Fwww%2Fnextcloud%2Focc&command=preview%3Apre-generate&container=nextcloud&stderr=true&stdout=true

  preview-generate-all.sh: |
    #!/bin/sh
    # Point to the internal API server hostname
    APISERVER=https://kubernetes.default.svc

    # Path to ServiceAccount token
    SERVICEACCOUNT=/var/run/secrets/kubernetes.io/serviceaccount

    # Read the ServiceAccount bearer token
    TOKEN=$(cat ${SERVICEACCOUNT}/token)

    # Reference the internal certificate authority (CA)
    CACERT=${SERVICEACCOUNT}/ca.crt

    # exec to nextcloud-web-0 pod and run:
    # php /config/www/nextcloud/occ preview:generate-all -p /hubbe/files/Photos
    curl \
    --cacert ${CACERT} \
    --header "Authorization: Bearer ${TOKEN}" \
    -X POST \
    ${APISERVER}/api/v1/namespaces/default/pods/nextcloud-web-0/exec?command=sudo&command=-u&command=abc&command=php&command=%2Fconfig%2Fwww%2Fnextcloud%2Focc&command=preview%3Agenerate-all&command=-p&command=%2Fhubbe%2Ffiles%2FPhotos&container=nextcloud&stderr=true&stdout=true
