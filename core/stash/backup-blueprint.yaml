apiVersion: stash.appscode.com/v1beta1
kind: BackupBlueprint
metadata:
  name: app-backup
spec:
  backend:
    local:
      mountPath: /safe/data
      subPath: ${TARGET_NAME}
      persistentVolumeClaim:
        claimName: nfs-backups
    storageSecretName: stash-restic-secret
  schedule: "0 19 * * *"
  backupHistoryLimit: 2
  runtimeSettings:
    container:
      resources:
        limits:
          cpu: 500m
      nice:
        adjustment: 5  # 'reduce' cpu niceness to 15 from 10
      ionice:
        class: 2       # best-effort
        classData: 7   # lowest-priority
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
    pod:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: "app.kubernetes.io/component"
                    operator: In
                    values:
                      - "stash-backup"
              topologyKey: "kubernetes.io/hostname"
  tempDir:
    medium: "Memory"
    sizeLimit: 2Gi
  retentionPolicy:
    name: 'tiered-keep-6M'
    keepMonthly: 6
    keepWeekly: 8
    keepDaily: 7
    prune: true
