apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: galactica-zfs-rules
  namespace: monitoring
  labels:
    prometheus: k8s
    role: alert-rules
spec:
  groups:
    - name: zfs.rules
      rules:
        - alert: PoolFillingUp
          annotations:
            description: "Based on recent sampling, the ZFS pool {{ $labels.pool }} is expected to fill up within 30 days. Currently {{ $value | humanizePercentage }} is available."
            summary: "ZFS pool is filling up."
          expr: '(zfs_pool_free_bytes/zfs_pool_size_bytes) < 0.10 and zfs_pool_allocated_bytes > 0 and predict_linear(zfs_pool_free_bytes[6h], 30*24*3600) < 0'
          for: 1h
          labels:
            severity: warning
        - alert: PoolNearFull
          annotations:
            description: "The ZFS pool {{ $labels.pool }} has less than 15% space free."
            summary: "ZFS pool almost full"
          expr: "(zfs_pool_free_bytes/zfs_pool_size_bytes) < 0.15"
          for: 2m
          labels:
            severity: warning
        - alert: DatasetQuotaNearFull
          annotations:
            description: "The ZFS dataset {{ $labels.name }} is over 80% full. Currently {{ $value | humanizePercentage }} quota is used."
            summary: "ZFS dataset quota almost used up."
          expr: "(zfs_dataset_used_bytes/zfs_dataset_quota_bytes) > 0.8 and zfs_dataset_quota_bytes != 0"
          for: 2m
          labels:
            severity: warning
        - alert: PoolDegraded
          annotations:
            description: "The ZFS pool {{ $labels.pool }} is in a DEGRADED state."
            summary: "ZFS pool is in a DEGRADED state."
          expr: zfs_pool_health == 1
          for: 2m
          labels:
            severity: warning
        - alert: PoolFaulted
          annotations:
            description: "The ZFS pool {{ $labels.pool }} is in a FAULTED state."
            summary: "ZFS pool is in a FAULTED state."
          expr: zfs_pool_health == 2
          for: 2m
          labels:
            severity: critical
        - alert: PoolOffline
          annotations:
            description: "The ZFS pool {{ $labels.pool }} is OFFLINE."
            summary: "ZFS pool is OFFLINE."
          expr: zfs_pool_health == 3
          for: 2m
          labels:
            severity: critical
